<!-- ############################### TAGS IN ################################# -->

<script type="text/javascript">
  RED.nodes.registerType("tags_in", {
    category: "CX Tags",
    color: "#4db6ac",
    defaults: {
      name: {value: ""},
      isBatch: {value: false},
      tagName: {value: ""},
      desc: {value: ""},
      // dType: {value: "auto"},
    },
    inputs: 1,
    outputs: 1,
    icon: "link-out.png",
    paletteLabel: "Tags In",
    label: function() {
      return this.name || ( this.isBatch ? "Batch In" : (this.tagName || "Tag In"));
    },
    oneditprepare: function() {

      const tagInGroupEl = $('#node-input-group-tag-in');
      const isBatchEl = $('#node-input-isBatch');
      // const dTypeEl = $("#node-input-dType");

      checkBatchStatus();

      isBatchEl.on("change", function() {
        checkBatchStatus();
      })

      // dTypeEl.typedInput({
      //   types: [
      //     {
      //       value: "auto",
      //       options: [
      //         { value: "auto", label: "auto detect"},
      //         { value: "number", label: "number"},
      //         { value: "boolean", label: "boolean"},
      //         { value: "string", label: "string"},
      //       ]
      //     }
      //   ]
      // })





      function checkBatchStatus() {
        if (isBatchEl.is(':checked')) tagInGroupEl.hide();
        else tagInGroupEl.show();
      }

    }
  });
</script>

<script type="text/html" data-template-name="tags_in">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-isBatch">Tags Batch</label>
    <input type="checkbox" id="node-input-isBatch" style="display:inline-block; width:auto; vertical-align:baseline; margin-left:8px; margin-right:4px;">
  </div>
  <div id="node-input-group-tag-in">
    <div class="form-row">
      <label for="node-input-tagName">Tag name</label>
      <input type="text" id="node-input-tagName" placeholder="SysOk_S">
    </div>
    <div class="form-row">
      <label for="node-input-desc">Description</label>
      <input type="text" id="node-input-desc" placeholder="System Healthy Status">
    </div>
<!--    <div class="form-row">-->
<!--      <label for="node-input-dType">Data type</label>-->
<!--      <input type="text" id="node-input-dType">-->
<!--    </div>-->
  </div>
</script>

<script type="text/html" data-help-name="tags_in">
  <h3>Inputs</h3>
  <pre style="overflow-x: scroll; white-space: pre;">
// if is batch
payload: {
  tagName: number | boolean | string
},
desc: {
  tagName: string
}
  </pre>
  <p>OR</p>
  <pre style="overflow-x: scroll; white-space: pre;">
// if a single tag
payload: number | boolean | string
topic?: string // tag name - optional if specified in Node Config
desc?: string // description - optional if specified in Node Config
  </pre>
  <p>OR</p>
  <pre style="overflow-x: scroll; white-space: pre;">
deleteTag: true,
topic: string // tag name
  </pre>
</script>



<!-- ############################### VALUE EMITTER ################################# -->

<script type="text/javascript">
  RED.nodes.registerType("value_emitter", {
    category: "CX Tags",
    color: "#4db6ac",
    defaults: {
      name: {value: ""},
      isToEmitAllChanges: {value: false},
      tagName: {value: "", required: true},
      emitOnStart: {value: true},
    },
    inputs: 0,
    outputs: 1,
    icon: "link-out.png",
    paletteLabel: "Emit tag",
    label: function() {
      return this.name || (
        this.isToEmitAllChanges ?
          "Emits: all" :
          (this.tagName.includes(",") ? "Emits: some" : "Emits:" + this.tagName)
      );
    },
    button: {
      enabled: function() {
        return !this.changed
      },
      onclick: function () {
        if (this.changed) {
          return RED.notify("Deploy before using button", "warning");
        }

        const customMsg = {
          nodeId: this.id
        }

        $.ajax({
          url: "__cx_tag_emitter/emit_request/" + this.id,
          type: "POST",
          data: JSON.stringify(customMsg),
          contentType: "application/json; charset=utf-8",
          success: () => {
            const tagsEmitted = this.isToEmitAllChanges ?
                    "all" : this.tagName;

            RED.notify("Emitted: " + tagsEmitted, { type: "success", id: "inject", timeout: 2000 });
          },
          error: function (jqXHR) {
            RED.notify("Error " + jqXHR.status, "error");
          }
        });
      }
    },
    oneditprepare: function () {

      const sectionEl = $('#node-input-section1');
      const isToEmitAllChangesEl = $('#node-input-isToEmitAllChanges');

      // checkBatchStatus();

      isToEmitAllChangesEl.on("change", function() {
        checkBatchStatus();
      })

      function checkBatchStatus() {
        if (isToEmitAllChangesEl.is(':checked')) sectionEl.hide();
        else {
          sectionEl.show();
          $.getJSON('__cx_tag_emitter/get_variables?config_id=' + this.id, function(data) {
            if (!data) return;
            $("#node-input-tag-name-list").text(data.join("\n"))
          });
        }
      }
    }
  });
</script>

<script type="text/html" data-template-name="value_emitter">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-isToEmitAllChanges"></label>
    <input type="checkbox" id="node-input-isToEmitAllChanges" style="display:inline-block; width:auto; vertical-align:baseline; margin-left:8px; margin-right:4px;">
    <span>Emit All Changes</span>
  </div>
  <div class="form-row">
    <label for="node-input-emitOnStart"></label>
    <input type="checkbox" id="node-input-emitOnStart" style="display:inline-block; width:auto; vertical-align:baseline; margin-left:8px; margin-right:4px;">
    <span>Emit On Start</span>
  </div>
  <div id="node-input-section1">
    <div class="form-row">
      <label for="node-input-tagName">Tag name</label>
      <input type="text" id="node-input-tagName" placeholder="SysOk_S">
    </div>
    <div class="form-row">
      <label for="node-input-tagName">Tag List</label>
      <code style="display: block; white-space: pre-wrap; height: 300px" id="node-input-tag-name-list"></code>
    </div>
  </div>
</script>

<script type="text/html" data-help-name="value_emitter">
  <p>Outputs</p>
  <p>Out as only one tag</p>
  <pre>
{
    topic: tagName as `string`
    payload: tagValue as `any`
}
  </pre>
  <p>Out as the batch</p>
  <pre>
{
    topic: "__batch",
    payload: {
        [tagName: string]: tagValue
    }
}
  </pre>
  <p>All changes, same message structure even if one change</p>
  <pre>
{
    topic: "__batch_all",
    payload: {
        [tagName: string]: tagValue
    }
}
  </pre>

</script>
